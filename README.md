# 클립보드 복사 텍스트 계좌번호 추출 기능

클립보드 복사 텍스트에서 사용자가 필요로 하는 정보일 확률이 가장 높은
[금융기관 / 계좌번호 / 금액] 1 SET를 추출

추후 고도화 및 UI 추가될 경우를 대비하여 모든 경우의 수를 반환

### 원칙

- Javascript 문법은 최신 문법을 지양하고 기존 코드 기준으로 작업하였습니다.
- 최대한 기존 코드를 수정하지 않는 쪽으로 작업하였습니다.

### 메인 아이디어

1. **금액**을 가장 먼저 추출한다.
   금액을 추출한 뒤 금액에 해당하는 숫자를 제거한다.
   공백, 개행, 하이픈을 제거한다.

2. **계좌번호**를 추출한다.

3. **은행명**을 추출한다.
   은행명으로 추정되는 문자열이 2개 이상일 경우
   이전 단계에서 추출한 <u>계좌번호와 가장 인접한 문자열</u>을 은행명으로 추출한다.

<br>

- 요건 변경 요청건(부산장례식장 -> 부산은행으로 추출되는 케이스)과 같이
  은행명이 2개이상 추출되는 경우가 가장 많을 것이라고 생각하였습니다. (지역명, 예금주명 등)
- 은행명으로 추출된 것 중 가장 은행명일 확률이 높은 것을 계좌번호와의 인접도로 판단하고자 했습니다.

### 주요 수정사항

##### 금액을 가장 먼저 추출하는 이유

- "숫자+원"으로 추출되기 때문에 추출이 비교적 용이함
- 공백 제거 이전에 추출되어야 잘못 추출되는 케이스를 줄이고 많은 케이스를 커버할 수 있음
  - ex) _"33312341234 10000원"_ 의 경우 공백이 제거된 후 금액이 추출된다면
    계좌번호와 붙어 1002447094085910000원으로 잘못 추출될 수 있음
    계좌번호 또한 33312341234100 등으로 잘못 추출될 수 있음

##### 계좌번호 - 은행명 인접도 계산 (텍스트 임베딩)

- `indexOf` 메소드를 통해 계좌번호 인덱스, 은행명 인덱스 위치 파악
- `Math.abs()`를 사용하여 계좌번호-은행명 간 인접도(거리) 계산
- 인접도가 가장 작은 (계좌번호와 가장 가까이에 있는) 은행명을 최종 은행명으로 추출
  <br>
- 자연어처리 과정에서 텍스트 전처리 시, 계산을 위해 특정 단어/형태소를 숫자로 변환하는 원핫인코딩 과정을 거침
- 원핫인코딩에서 아이디어를 얻어 계좌번호는 "@", 은행명은 "#" 등 임의의 기호로 `replace` 후 인덱스를 통한 인접도 계산을 수행하였음
- 계좌번호 길이, 은행명 길이가 인접도 계산에 영향을 미치지 않게 하기 위함

##### 계좌번호 자릿수가 긴 순서로 정렬하는 이유

- 핸드폰 번호, 예매번호 등 7~15자리 숫자 정규식으로 추출될 수 있는 계좌번호가 아닌 번호들이 있음
- 이러한 케이스들이 계좌번호보다(일반적인 시중은행 개인계좌의 경우 11~14자리) 길이가 짧은 숫자인 경우가 많으므로 계좌번호를 우선시하기 위해 자릿수 정렬을 1회 실시
- 추후 다른 방법으로 고도화 가능

### 기타 수정사항

- `regClean`으로 영문, 한글, 숫자 외 모든 요소를 제거 (특수문자 및 공백 제거)

  - `var regClean = /[^a-z|A-Z|0-9|ㄱ-ㅎ|가-힣]/g;`

  - 추출된 계좌번호, 은행명을 "#" "@" 등의 임의의 특수문자로 교체한 후 인덱스를 구해 인접도를 계산하는 로직을 사용하므로 기존 텍스트에 특수문자가 있어서는 안됨.
  - 은행명/계좌번호/금액 추출에 영문, 한글, 숫자 외의 텍스트는 불필요하다고 판단
  - 특별한 이유가 있는 것이 아니라면 공백을 제거할 때 특수문자 등의 제거를 위해 영문, 한글, 숫자 외의 다른 것을 허용하지 않는 정규표현식으로 전처리 수행
    <br>

- 우리"은행", 하나"은행" 등 은행이 붙은 것도 정규식 패턴에 추가

  - 이유: "이우리", "김하나" 등 예금주명이 은행명과 혼동이 있을 때 정확한 인접도 계산을 하기 위함

    - ex) _"국민은행 33312341234 이하나 15000원"_ 의 경우

      "국민은행"이 정규식 패턴에 없을 시
      => ["국민", "하나"]로 검출, - (국민)xx(계좌번호)로 인접도가 2 - (계좌번호)x(하나)로 인접도가 1
      => 인접도에 따른 은행명 검출 시 {instCode: 하나은행, instAccount: "33312341234", txAmt: "15000원"} 로 return

      "국민은행"이 정규식 패턴에 있을 시
      => ["국민은행", "하나"]로 검출, - (국민은행)(계좌번호)로 인접도가 0 - (계좌번호)x(하나)로 인접도가 1
      => 인접도에 따른 은행명 검출 시 {instCode: 국민은행, instAccount: "33312341234", txAmt: "15000원"} 로 return

      cf) _"국민은행 33312341234 하나리"_
      cf) _"국민의당 33312341234 (케이뱅크)"_
      cf) _"케이뱅크 이하나 33312341234"_

### 테스트 코드

Jest를 사용하여 테스트 환경 구성

```
npm install --save-dev jest
npm test
```

![테스트결과](./npm_test.png)

```js
var test2 = `장지: 부산 장례식장 마음을 전하실 곳: 하나은행 100-1234-5679 김케이`;
it(`장지: 부산 장례식장
마음을 전하실 곳: 하나은행 100-1234-5679 김케이`, () => {
  expect(clipboard.getResult(test2)).toEqual({
    instCode: "081",
    instAccount: "10012345679",
    txAmt: "",
  });
});
```

### 추가 구현 아이디어

#### 계좌번호 추출 고도화

계좌번호로 추정되는 문자열이 여러건 검출되었는데, 은행명은 단 1개만 검출된 경우
계좌번호도 단 1개일 확률이 높음
=> 계좌번호일 확률이 가장 높은 1건을 우선도 파악 후 추출

##### - 핸드폰번호와 계좌번호가 모두 추출될 경우 계좌번호를 우선하여 추출

```js
var regPhone = /^01([0|1|6|7|8|9])-?([0-9]{3,4})-?([0-9]{4})$/; // 핸드폰 번호
```

정규표현식을 통해 핸드폰번호 구분 가능하나 평생계좌번호 등의 케이스가 있어 고려 필요

##### - 11~14자리 계좌번호를 10자리 이하/15자리 계좌번호보다 우선시

- 신한 12자리 / 우리 13자리 / 하나 14자리 등 대부분의 시중은행에서 11~14자리 계좌번호를 주로 사용하고 있는 것으로 파악
- 11~14자리를 10자리 이하/15자리 계좌번호보다 우선시하는 로직을 고려해보았음

#### 다건 추출

지로 납부, 모바일 청첩장(신랑측, 신부측) 등의 경우
계좌정보 SET가 다건 검출되는 경우 있을 수 있음

##### - [은행명-계좌번호]가 여러 SET일 경우

은행명 검출 개수 = 계좌번호 검출 개수일 경우 순서대로 매치하여 SET별 객체를 array에 담아 return

##### - 여러개가 검출되는 경우 가능한 모든 SET를 모두 제시

은행명은 ['하나', '신한'] / 계좌번호는 ['1001234561823'] 와 같이 개수가 다르게 검출되었을 경우
가능한 모든 경우를 조합하여 array에 담아 return

#### "원"이 붙지 않는 금액 추출

- '-'과 ','을 전처리 하지 않고, ','이 섞여있는 숫자의 경우 금액으로 판단
- 끝자리가 00으로 끝나는 0으로 시작하지 않는 3~7자리 숫자의 경우 정규표현식을 통해 금액으로 판단

#### 계좌번호가 추출되지 않는 경우 처리

- 현재 로직에서 어떻게 처리되고 있는지 궁금합니다.
- 계좌번호가 추출되지 않는 경우 빈 객체 ({})를 return 하는 등의 처리 필요

---

### [Appendix]

#### 정규표현식

- | : 또는
- /g : 모든 문자를 검색하겠다. 모든 검색 결과를 배열로 반환
- /i : 대소문자 구별 안함
- `match`, `test`, `search`

#### match / matchAll

##### match

- g 플래그에 따른 결과 Array를 반환, 매치되는 결과가 없다면 null를 반환한다.
- match()메서드와 g플래그를 같이 사용했을 경우 매치되는 전체를 얻을 순 있지만, index, input, groups 3개의 프로퍼티는 사용할 수 없다.

##### matchAll (ES2020)

- g 플래그가 없다면 TypeError가 발생한다.

##### => matchAll을 사용하지 못하기 때문에 indexOf로 인덱스를 구해서 사용

#### for문에서 var를 사용할 때 주의점

- https://velog.io/@draw/for%EB%AC%B8%EC%97%90%EC%84%9C-var%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%A9%B4-%EC%83%9D%EA%B8%B0%EB%8A%94-%EB%AC%B8%EC%A0%9C%EC%A0%90

- https://www.daleseo.com/js-var-issues/

#### 자바스크립트 문법 사용 가능 여부 체크

caniuse.com 참고
